<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CardGuard - Credit Card Reminder</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6366f1">
    <meta name="description" content="Never miss a credit card payment with CardGuard">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CardGuard">

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* ========================================
           CSS VARIABLES & THEMING
        ======================================== */
        :root {
            /* Light Theme */
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --card-shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.3);
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border-color: #334155;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
            --card-shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 8px 10px -6px rgba(0, 0, 0, 0.4);
            --glass-bg: rgba(30, 41, 59, 0.8);
            --glass-border: rgba(51, 65, 85, 0.5);
        }

        /* ========================================
           BASE STYLES & RESET
        ======================================== */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        /* ========================================
           ANIMATED BACKGROUND
        ======================================== */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }

        .bg-animation::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(236, 72, 153, 0.05) 0%, transparent 40%);
            animation: bgFloat 20s ease-in-out infinite;
        }

        @keyframes bgFloat {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(2%, 2%) rotate(2deg); }
            66% { transform: translate(-1%, 1%) rotate(-1deg); }
        }

        /* ========================================
           HEADER & NAVIGATION
        ======================================== */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 1rem 1.5rem;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--accent-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.2s ease;
        }

        .icon-btn:hover {
            background: var(--bg-tertiary);
            transform: translateY(-2px);
        }

        .icon-btn:active {
            transform: translateY(0);
        }

        /* ========================================
           NAVIGATION TABS
        ======================================== */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .nav-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .nav-tab.active {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: var(--bg-tertiary);
        }

        /* ========================================
           MAIN CONTENT AREA
        ======================================== */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .view {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========================================
           STATS CARDS
        ======================================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 1.25rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .stat-icon.primary { background: rgba(99, 102, 241, 0.1); }
        .stat-icon.success { background: rgba(16, 185, 129, 0.1); }
        .stat-icon.warning { background: rgba(245, 158, 11, 0.1); }
        .stat-icon.danger { background: rgba(239, 68, 68, 0.1); }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* ========================================
           SECTION HEADERS
        ======================================== */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* ========================================
           CREDIT CARDS GRID
        ======================================== */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1.5rem;
        }

        /* ========================================
           CARD WRAPPER WITH ACTIONS
        ======================================== */
        .card-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* ========================================
           CREDIT CARD COMPONENT
        ======================================== */
        .credit-card {
            position: relative;
            aspect-ratio: 1.586 / 1;
            border-radius: 20px;
            padding: 1.5rem;
            color: white;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--card-shadow);
        }

        .credit-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: inherit;
            z-index: -1;
        }

        .credit-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                    45deg,
                    transparent 40%,
                    rgba(255, 255, 255, 0.1) 45%,
                    rgba(255, 255, 255, 0.2) 50%,
                    rgba(255, 255, 255, 0.1) 55%,
                    transparent 60%
            );
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .credit-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--card-shadow-hover);
        }

        .credit-card:hover::after {
            transform: translateX(100%);
        }

        /* Card Background Patterns */
        .card-pattern {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.15;
            pointer-events: none;
        }

        .card-pattern.circles {
            background:
                    radial-gradient(circle at 100% 0%, rgba(255,255,255,0.3) 0%, transparent 50%),
                    radial-gradient(circle at 0% 100%, rgba(255,255,255,0.2) 0%, transparent 50%);
        }

        .card-pattern.waves {
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='rgba(255,255,255,0.1)' d='M0 50 Q25 30 50 50 T100 50 V100 H0Z'/%3E%3C/svg%3E");
            background-size: 200px;
        }

        .card-pattern.grid {
            background:
                    linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px),
                    linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Card Content */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .card-bank-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bank-logo {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            backdrop-filter: blur(10px);
        }

        .card-bank {
            font-size: 1rem;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .card-chip {
            width: 45px;
            height: 35px;
            background: linear-gradient(135deg, #ffd700 0%, #ffb700 50%, #ffd700 100%);
            border-radius: 6px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .card-chip::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 60%;
            background:
                    linear-gradient(90deg, transparent 30%, rgba(0,0,0,0.1) 30%, rgba(0,0,0,0.1) 35%, transparent 35%),
                    linear-gradient(transparent 45%, rgba(0,0,0,0.1) 45%, rgba(0,0,0,0.1) 55%, transparent 55%);
            border-radius: 3px;
        }

        .card-number {
            font-family: 'Orbitron', monospace;
            font-size: 1.25rem;
            letter-spacing: 3px;
            margin-bottom: 1.25rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            position: relative;
            z-index: 1;
        }

        .card-info {
            flex: 1;
        }

        .card-holder-name {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 0.5rem;
            opacity: 0.95;
        }

        .card-name {
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.25rem;
            opacity: 0.8;
        }

        .card-dates {
            display: flex;
            gap: 1.5rem;
            font-size: 0.7rem;
            opacity: 0.9;
        }

        .card-date-item span {
            opacity: 0.7;
            font-size: 0.55rem;
            text-transform: uppercase;
            display: block;
        }

        /* ========================================
           NETWORK LOGOS
        ======================================== */
        .card-network {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
            height: 40px;
        }

        /* VISA Logo */
        .network-visa {
            position: relative;
        }

        .network-visa svg {
            width: 60px;
            height: 20px;
        }

        /* MasterCard Logo */
        .network-mastercard {
            position: relative;
            width: 50px;
            height: 30px;
        }

        .network-mastercard::before,
        .network-mastercard::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
        }

        .network-mastercard::before {
            background: #eb001b;
            left: 0;
        }

        .network-mastercard::after {
            background: #f79e1b;
            right: 0;
        }

        .network-mastercard-overlap {
            position: absolute;
            width: 10px;
            height: 26px;
            background: #ff5f00;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
        }

        /* RuPay Logo */
        .network-rupay {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .network-rupay svg {
            width: 55px;
            height: 22px;
        }

        /* American Express Logo */
        .network-amex {
            background: linear-gradient(135deg, #006fcf 0%, #0055a5 100%);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 800;
            letter-spacing: 0.5px;
            text-align: center;
            line-height: 1.1;
        }

        /* Diners Club Logo */
        .network-diners {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .network-diners svg {
            width: 40px;
            height: 30px;
        }

        /* Due Date Badge */
        .due-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: pulse 2s infinite;
        }

        .due-badge.urgent {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .due-badge.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .due-badge.safe {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .due-badge.paid {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Card Actions */
        .card-actions {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 10;
        }

        .credit-card:hover .card-actions {
            opacity: 1;
        }

        .card-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }

        .card-action-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        /* ========================================
           MARK AS PAID BUTTON
        ======================================== */
        .payment-actions {
            display: flex;
            gap: 0.5rem;
        }

        .mark-paid-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .mark-paid-btn:hover {
            border-color: var(--success);
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .mark-paid-btn.paid {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: transparent;
            color: white;
        }

        .mark-paid-btn.paid:hover {
            opacity: 0.9;
        }

        /* ========================================
           ADD CARD BUTTON
        ======================================== */
        .add-card-btn {
            aspect-ratio: 1.586 / 1;
            border-radius: 20px;
            border: 3px dashed var(--border-color);
            background: var(--bg-secondary);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            transition: all 0.3s ease;
            color: var(--text-muted);
        }

        .add-card-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: translateY(-4px);
        }

        .add-card-btn .icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }

        .add-card-btn:hover .icon {
            background: var(--accent-gradient);
            color: white;
        }

        /* ========================================
           MODAL STYLES
        ======================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 24px;
            width: 100%;
            max-width: 560px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
        }

        /* ========================================
           FORM STYLES
        ======================================== */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* Bank Selector */
        .bank-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 2px solid var(--border-color);
        }

        .bank-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 0.5rem;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            text-align: center;
        }

        .bank-option:hover {
            background: var(--bg-secondary);
        }

        .bank-option.selected {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .bank-option-logo {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: white;
        }

        .bank-option-name {
            font-size: 0.65rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .other-bank-input {
            display: none;
            margin-top: 0.75rem;
        }

        .other-bank-input.show {
            display: block;
        }

        /* Color Picker */
        .color-picker-wrapper {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: var(--text-primary);
            box-shadow: 0 0 0 2px var(--bg-secondary);
        }

        /* Notification Preferences */
        .notification-prefs {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 1rem;
            border: 2px solid var(--border-color);
        }

        .notification-pref-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .notification-pref-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .notification-pref-item:first-child {
            padding-top: 0;
        }

        .notification-pref-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .custom-date-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }

        .custom-date-input .form-input {
            width: 80px;
            padding: 0.5rem 0.75rem;
            text-align: center;
        }

        /* Reminder Options */
        .reminder-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .reminder-chip {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 2px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .reminder-chip.selected {
            background: var(--accent-gradient);
            border-color: transparent;
            color: white;
        }

        /* ========================================
           TOGGLE SWITCH
        ======================================== */
        .toggle {
            position: relative;
            width: 52px;
            height: 28px;
            flex-shrink: 0;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-tertiary);
            border-radius: 28px;
            transition: all 0.3s ease;
            border: 2px solid var(--border-color);
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle input:checked + .toggle-slider {
            background: var(--accent-gradient);
            border-color: transparent;
        }

        .toggle input:checked + .toggle-slider::before {
            transform: translateX(24px);
        }

        /* ========================================
           BUTTONS
        ======================================== */
        .btn {
            padding: 0.875rem 1.5rem;
            border-radius: 12px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-block {
            width: 100%;
        }

        /* ========================================
           TIMELINE VIEW
        ======================================== */
        .timeline {
            position: relative;
            padding-left: 2rem;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--border-color);
            border-radius: 3px;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 1.5rem;
            padding-left: 1.5rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -2rem;
            top: 0.5rem;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent-primary);
            border: 3px solid var(--bg-secondary);
            box-shadow: 0 0 0 3px var(--accent-primary);
        }

        .timeline-item.urgent::before {
            background: var(--danger);
            box-shadow: 0 0 0 3px var(--danger);
        }

        .timeline-item.warning::before {
            background: var(--warning);
            box-shadow: 0 0 0 3px var(--warning);
        }

        .timeline-item.paid::before {
            background: var(--success);
            box-shadow: 0 0 0 3px var(--success);
        }

        .timeline-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 1.25rem;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .timeline-card:hover {
            box-shadow: var(--card-shadow);
        }

        .timeline-date {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .timeline-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .timeline-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .paid-badge {
            background: var(--success);
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* ========================================
           CALENDAR VIEW
        ======================================== */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .calendar-nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .calendar-nav-btn:hover {
            background: var(--bg-tertiary);
        }

        .calendar-month {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            padding: 0.5rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            font-size: 0.875rem;
        }

        .calendar-day:hover {
            background: var(--bg-tertiary);
        }

        .calendar-day.today {
            background: var(--accent-gradient);
            color: white;
            border-color: transparent;
        }

        .calendar-day.has-due {
            position: relative;
        }

        .calendar-day.has-due::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--danger);
        }

        .calendar-day.has-billing::after {
            background: var(--warning);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        /* ========================================
           SETTINGS VIEW
        ======================================== */
        .settings-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .settings-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .settings-item-info h4 {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .settings-item-info p {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* ========================================
           NOTIFICATION PERMISSION BANNER
        ======================================== */
        .notification-banner {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 16px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .notification-banner.hidden {
            display: none;
        }

        .notification-banner-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification-banner-icon {
            font-size: 1.5rem;
        }

        .notification-banner h3 {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .notification-banner p {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .notification-banner .btn {
            background: white;
            color: var(--accent-primary);
        }

        /* ========================================
           EMPTY STATE
        ======================================== */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            margin-bottom: 1.5rem;
        }

        /* ========================================
           TOAST NOTIFICATIONS
        ======================================== */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            border: 1px solid var(--border-color);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            min-width: 300px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast.success .toast-icon { color: var(--success); }
        .toast.error .toast-icon { color: var(--danger); }
        .toast.warning .toast-icon { color: var(--warning); }
        .toast.info .toast-icon { color: var(--accent-primary); }

        .toast-message {
            flex: 1;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        /* ========================================
           RESPONSIVE STYLES
        ======================================== */
        @media (max-width: 768px) {
            .header-content {
                padding: 0;
            }

            .logo-text {
                font-size: 1.25rem;
            }

            .nav-tabs {
                padding: 0.75rem;
            }

            .nav-tab {
                padding: 0.625rem 0.75rem;
                font-size: 0.75rem;
            }

            .nav-tab span {
                display: none;
            }

            .main-content {
                padding: 1rem;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .credit-card {
                padding: 1.25rem;
            }

            .card-number {
                font-size: 1rem;
                letter-spacing: 2px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal {
                max-height: 95vh;
                border-radius: 20px 20px 0 0;
                margin-top: auto;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .toast-container {
                left: 1rem;
                right: 1rem;
                bottom: 1rem;
            }

            .toast {
                min-width: unset;
            }

            .bank-selector {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .bank-selector {
                grid-template-columns: repeat(3, 1fr);
            }

            .card-holder-name {
                font-size: 0.75rem;
            }
        }

        /* ========================================
           SCROLLBAR STYLES
        ======================================== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* ========================================
           PRINT STYLES
        ======================================== */
        @media print {
            .header, .nav-tabs, .add-card-btn, .card-actions, .notification-banner, .payment-actions {
                display: none !important;
            }

            .credit-card {
                break-inside: avoid;
                box-shadow: none;
                border: 2px solid #000;
            }
        }

        /* ========================================
   NETWORK LOGO IMAGES
======================================== */
        .network-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 40px;
        }

        .network-logo img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            border-radius: 4px;
        }

        /* ========================================
   NOTIFICATION TIME PICKER
======================================== */
        .notification-times-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            width: 100%;
        }

        .time-checkbox {
            cursor: pointer;
        }

        .time-checkbox input {
            display: none;
        }

        .time-checkbox-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem 0.75rem;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            background: var(--bg-tertiary);
            transition: all 0.2s ease;
            text-align: center;
        }

        .time-checkbox input:checked + .time-checkbox-box {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .time-checkbox:hover .time-checkbox-box {
            border-color: var(--accent-primary);
        }

        .time-icon {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .time-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .time-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        /* Custom Time Input */
        .custom-time-input-wrapper {
            width: 100%;
            display: none;
            flex-direction: column;
            gap: 0.5rem;
        }

        .custom-time-input-wrapper.show {
            display: flex;
        }

        .time-input {
            max-width: 150px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .custom-time-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Notification Frequency Selector */
        .notification-frequency-selector {
            display: flex;
            gap: 0.5rem;
            background: var(--bg-tertiary);
            padding: 0.25rem;
            border-radius: 10px;
        }

        .freq-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .freq-btn:hover {
            background: var(--bg-secondary);
        }

        .freq-btn.active {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        /* Urgent Alert Indicator on Cards */
        .urgent-pulse {
            animation: urgentPulse 1.5s ease-in-out infinite;
        }

        @keyframes urgentPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }

        /* Notification Preview Card */
        .notification-preview {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px dashed var(--border-color);
        }

        .notification-preview-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
        }

        .notification-preview-content {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .notification-preview-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .notification-preview-text h5 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .notification-preview-text p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .notification-schedule-summary {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .schedule-summary-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .schedule-times-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .schedule-time-tag {
            background: var(--bg-secondary);
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .schedule-time-tag.active {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .schedule-time-tag.custom {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--warning);
            color: var(--warning);
        }

        /* Mobile Responsive for Time Grid */
        @media (max-width: 480px) {
            .notification-times-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
            }

            .time-checkbox-box {
                padding: 0.75rem 0.5rem;
            }

            .time-icon {
                font-size: 1.25rem;
            }

            .time-label {
                font-size: 0.8rem;
            }

            .time-desc {
                display: none;
            }
        }

        /* ========================================
   SCHEDULED DATES SECTION
======================================== */
        .scheduled-dates-section {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .scheduled-dates-label,
        .schedule-times-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .scheduled-dates-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .scheduled-date-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-secondary);
            padding: 0.625rem 0.875rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .scheduled-date-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .scheduled-date-icon {
            font-size: 1rem;
        }

        .scheduled-date-text {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .scheduled-date-card {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
        }

        .scheduled-date-item.urgent {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.05);
        }

        .scheduled-date-item.urgent .scheduled-date-text {
            color: var(--danger);
            font-weight: 600;
        }

        .scheduled-date-item.warning {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.05);
        }

        .no-scheduled-dates {
            text-align: center;
            padding: 1rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .no-scheduled-dates .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        .schedule-times-section {
            margin-bottom: 1rem;
        }

        /* ========================================
           AM/PM TIME PICKER
        ======================================== */
        .time-picker-ampm {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-tertiary);
            padding: 0.5rem;
            border-radius: 12px;
            border: 2px solid var(--border-color);
        }

        .time-select {
            width: auto;
            min-width: 60px;
            padding: 0.5rem 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            border: none;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .time-select:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-primary);
        }

        .ampm-select {
            min-width: 70px;
            background: var(--accent-gradient);
            color: white;
        }

        .time-separator {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-muted);
        }

        /* Mobile adjustments */
        @media (max-width: 480px) {
            .scheduled-date-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.375rem;
            }

            .scheduled-date-card {
                margin-left: 1.5rem;
            }

            .time-picker-ampm {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

    </style>
</head>
<body>
<!-- Animated Background -->
<div class="bg-animation"></div>

<!-- Header -->
<header class="header">
    <div class="header-content">
        <div class="logo">
            <div class="logo-icon"></div>
            <span class="logo-text">CardGuard</span>
        </div>
        <div class="header-actions">
            <button class="icon-btn" id="exportBtn" title="Export Data"></button>
            <button class="icon-btn" id="importBtn" title="Import Data"></button>
            <button class="icon-btn" id="themeToggle" title="Toggle Theme"></button>
        </div>
    </div>
</header>

<!-- Navigation Tabs -->
<nav class="nav-tabs">
    <button class="nav-tab active" data-view="dashboard">
         <span>Dashboard</span>
    </button>
    <button class="nav-tab" data-view="timeline">
         <span>Timeline</span>
    </button>
    <button class="nav-tab" data-view="calendar">
         <span>Calendar</span>
    </button>
    <button class="nav-tab" data-view="settings">
         <span>Settings</span>
    </button>
</nav>

<!-- Main Content -->
<main class="main-content">
    <!-- Notification Permission Banner -->
    <div class="notification-banner" id="notificationBanner">
        <div class="notification-banner-content">
            <span class="notification-banner-icon"></span>
            <div>
                <h3>Enable Notifications</h3>
                <p>Get reminded before your payment due dates</p>
            </div>
        </div>
        <button class="btn" id="enableNotificationsBtn">Enable</button>
    </div>

    <!-- Dashboard View -->
    <section class="view active" id="dashboardView">
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon primary"></div>
                <div class="stat-value" id="totalCards">0</div>
                <div class="stat-label">Total Cards</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon danger"></div>
                <div class="stat-value" id="dueSoon">0</div>
                <div class="stat-label">Due in 3 Days</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon warning"></div>
                <div class="stat-value" id="billingSoon">0</div>
                <div class="stat-label">Billing Soon</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon success"></div>
                <div class="stat-value" id="paidCount">0</div>
                <div class="stat-label">Paid This Month</div>
            </div>
        </div>

        <!-- Cards Section -->
        <div class="section-header">
            <h2 class="section-title">My Credit Cards</h2>
        </div>

        <div class="cards-grid" id="cardsGrid">
            <!-- Cards will be rendered here -->
        </div>
    </section>

    <!-- Timeline View -->
    <section class="view" id="timelineView">
        <div class="section-header">
            <h2 class="section-title">Upcoming Dates</h2>
        </div>
        <div class="timeline" id="timeline">
            <!-- Timeline items will be rendered here -->
        </div>
    </section>

    <!-- Calendar View -->
    <section class="view" id="calendarView">
        <div class="calendar-header">
            <div class="calendar-nav">
                <button class="calendar-nav-btn" id="prevMonth"></button>
                <h2 class="calendar-month" id="calendarMonth"></h2>
                <button class="calendar-nav-btn" id="nextMonth"></button>
            </div>
            <button class="btn btn-secondary" id="todayBtn">Today</button>
        </div>
        <div class="calendar-grid" id="calendarGrid">
            <!-- Calendar will be rendered here -->
        </div>
    </section>

    <!-- Settings View -->
    <!-- Settings View -->
    <section class="view" id="settingsView">
        <div class="settings-section">
            <h3 class="settings-section-title"> Notifications</h3>

            <!-- TEST BUTTONS - Only ONE set -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="testNotificationSimple()"> Test Simple</button>
                <button class="btn btn-secondary" onclick="testActualReminder()"> Test Reminder</button>
                <button class="btn btn-secondary" onclick="forceCheckNotifications()"> Force Check Now</button>
            </div>

            <!-- SCHEDULER STATUS -->
            <div id="schedulerStatus" style="background: var(--bg-tertiary); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; border: 1px solid var(--border-color);">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span id="schedulerDot" style="width: 12px; height: 12px; border-radius: 50%; background: #ef4444;"></span>
                    <strong id="schedulerStatusText">Scheduler: Checking...</strong>
                </div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                    <div> Current Time: <span id="currentTimeDisplay">--:--:--</span></div>
                    <div> Next Check: <span id="nextCheckTime">--:--</span></div>
                    <div> Today's Notifications: <span id="notifCountDisplay">0</span>/<span id="maxNotifDisplay">2</span></div>
                    <div> Selected Times: <span id="selectedTimesDisplay">None</span></div>
                    <div id="lastCheckResult" style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: 8px;">Last check: Not yet</div>
                </div>
            </div>

            <div class="settings-item">
                <div class="settings-item-info">
                    <h4>Push Notifications</h4>
                    <p>Receive browser notifications for reminders</p>
                </div>
                <label class="toggle">
                    <input type="checkbox" id="pushNotificationsToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <div class="settings-item-info">
                    <h4>Sound Alerts</h4>
                    <p>Play a sound when showing notifications</p>
                </div>
                <label class="toggle">
                    <input type="checkbox" id="soundAlertsToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <div class="settings-item-info">
                    <h4>Default Reminder Days</h4>
                    <p>Days before due date to remind</p>
                </div>
                <select class="form-select" id="defaultReminderDays" style="width: auto;">
                    <option value="1">1 day</option>
                    <option value="3" selected>3 days</option>
                    <option value="5">5 days</option>
                    <option value="7">7 days</option>
                </select>
            </div>

            <div class="settings-item" style="flex-direction: column; align-items: flex-start; gap: 1rem;">
                <div class="settings-item-info">
                    <h4>Preset Notification Times</h4>
                    <p>Select when to receive daily reminders</p>
                </div>
                <div class="notification-times-grid">
                    <label class="time-checkbox">
                        <input type="checkbox" id="notifyTime9AM">
                        <div class="time-checkbox-box">
                            <span class="time-icon"></span>
                            <span class="time-label">Morning</span>
                            <span class="time-desc">9:00 AM</span>
                        </div>
                    </label>
                    <label class="time-checkbox">
                        <input type="checkbox" id="notifyTime2PM">
                        <div class="time-checkbox-box">
                            <span class="time-icon"></span>
                            <span class="time-label">Afternoon</span>
                            <span class="time-desc">2:00 PM</span>
                        </div>
                    </label>
                    <label class="time-checkbox">
                        <input type="checkbox" id="notifyTime6PM">
                        <div class="time-checkbox-box">
                            <span class="time-icon"></span>
                            <span class="time-label">Evening</span>
                            <span class="time-desc">6:00 PM</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="settings-item" style="flex-direction: column; align-items: flex-start; gap: 1rem;">
                <div class="settings-item-info" style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                    <div>
                        <h4>Custom Notification Time</h4>
                        <p>Type any specific time you want</p>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="enableCustomTime">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="custom-time-input-wrapper" id="customTimeWrapper">
                    <input type="time" id="customNotificationTime" class="form-input" style="font-size: 1.2rem; padding: 0.5rem; border-radius: 10px; border: 2px solid var(--border-color); text-align: center; max-width: 200px;">
                    <span class="custom-time-hint">This will be added to your notification schedule</span>
                </div>
            </div>

            <div class="settings-item">
                <div class="settings-item-info">
                    <h4>Max Notifications Per Day</h4>
                    <p>Limit how many times you're notified daily</p>
                </div>
                <div class="notification-frequency-selector">
                    <button class="freq-btn" data-freq="1">1</button>
                    <button class="freq-btn active" data-freq="2">2</button>
                    <button class="freq-btn" data-freq="3">3</button>
                </div>
            </div>

            <div class="settings-item">
                <div class="settings-item-info">
                    <h4> Urgent Due Date Alerts</h4>
                    <p>Get special alerts for cards due today or tomorrow</p>
                </div>
                <label class="toggle">
                    <input type="checkbox" id="urgentAlertsToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="settings-item">
                <div class="settings-item-info">
                    <h4> Consolidated Summary</h4>
                    <p>Combine multiple card reminders into one notification</p>
                </div>
                <label class="toggle">
                    <input type="checkbox" id="consolidatedSummaryToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="notification-schedule-summary">
                <div class="schedule-summary-title">
                     Your Notification Schedule
                </div>

                <div class="scheduled-dates-section">
                    <div class="scheduled-dates-label">Upcoming Notification Dates:</div>
                    <div class="scheduled-dates-list" id="scheduledDatesList">
                    </div>
                </div>

                <div class="schedule-times-section">
                    <div class="schedule-times-label">Daily Notification Times:</div>
                    <div class="schedule-times-list" id="scheduleTimesList">
                    </div>
                </div>

                <div class="notification-preview" id="notificationPreview">
                    <div class="notification-preview-title">Preview</div>
                    <div class="notification-preview-content">
                        <div class="notification-preview-icon"></div>
                        <div class="notification-preview-text">
                            <h5>CardGuard Reminder</h5>
                            <p id="previewText">You have 2 cards due soon: HDFC (3 days), ICICI (5 days)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h3 class="settings-section-title"> Appearance</h3>
            <div class="settings-item">
                <div class="settings-item-info">
                    <h4>Dark Mode</h4>
                    <p>Toggle dark/light theme</p>
                </div>
                <label class="toggle">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <div class="settings-section">
            <h3 class="settings-section-title"> Data Management</h3>
            <div class="settings-item">
                <div class="settings-item-info">
                    <h4>Export Cards</h4>
                    <p>Download all card data as JSON</p>
                </div>
                <button class="btn btn-secondary" id="exportDataBtn">Export</button>
            </div>
            <div class="settings-item">
                <div class="settings-item-info">
                    <h4>Import Cards</h4>
                    <p>Import card data from JSON file</p>
                </div>
                <button class="btn btn-secondary" id="importDataBtn">Import</button>
            </div>
            <div class="settings-item">
                <div class="settings-item-info">
                    <h4>Clear All Data</h4>
                    <p>Delete all cards and settings</p>
                </div>
                <button class="btn btn-danger" id="clearDataBtn">Clear</button>
            </div>
        </div>

        <div class="settings-section">
            <h3 class="settings-section-title"> Install App</h3>
            <div class="settings-item">
                <div class="settings-item-info">
                    <h4>Install CardGuard</h4>
                    <p>Add to home screen for quick access</p>
                </div>
                <button class="btn btn-primary" id="installPwaBtn" style="display: none;">Install</button>
            </div>
        </div>
    </section>
</main>

<!-- Add/Edit Card Modal -->
<div class="modal-overlay" id="cardModal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">Add New Card</h2>
            <button class="modal-close" id="closeModal"></button>
        </div>
        <div class="modal-body">
            <form id="cardForm">
                <input type="hidden" id="cardId">

                <div class="form-group">
                    <label class="form-label">Card Holder Name *</label>
                    <input type="text" class="form-input" id="cardHolderName" placeholder="Name as on card" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Card Nickname</label>
                    <input type="text" class="form-input" id="cardName" placeholder="e.g., Shopping Card, Travel Card">
                </div>

                <div class="form-group">
                    <label class="form-label">Bank *</label>
                    <div class="bank-selector" id="bankSelector">
                        <!-- Banks will be rendered here -->
                    </div>
                    <div class="other-bank-input" id="otherBankInput">
                        <input type="text" class="form-input" id="customBankName" placeholder="Enter bank name">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Card Network *</label>
                        <select class="form-select" id="cardNetwork" required>
                            <option value="visa">Visa</option>
                            <option value="mastercard">MasterCard</option>
                            <option value="rupay">RuPay</option>
                            <option value="amex">American Express</option>
                            <option value="diners">Diners Club</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last 4 Digits *</label>
                        <input type="text" class="form-input" id="last4Digits" placeholder="1234" maxlength="4" pattern="[0-9]{4}" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Billing Date *</label>
                        <select class="form-select" id="billingDate" required>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date *</label>
                        <select class="form-select" id="dueDate" required>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Credit Limit (Optional)</label>
                    <input type="number" class="form-input" id="creditLimit" placeholder="100000">
                </div>

                <div class="form-group">
                    <label class="form-label">Card Color *</label>
                    <div class="color-picker-wrapper" id="colorPicker">
                        <!-- Colors will be rendered here -->
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Notification Preferences</label>
                    <div class="notification-prefs">
                        <div class="notification-pref-item">
                            <span class="notification-pref-label">
                                 Notify on Billing Date
                            </span>
                            <label class="toggle">
                                <input type="checkbox" id="notifyOnBilling">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="notification-pref-item">
                            <span class="notification-pref-label">
                                 Notify before Due Date
                            </span>
                            <label class="toggle">
                                <input type="checkbox" id="notifyBeforeDue" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="notification-pref-item" id="reminderDaysContainer">
                            <span class="notification-pref-label">
                                Days before due date
                            </span>
                            <div class="reminder-options" id="reminderOptions">
                                <div class="reminder-chip" data-days="1">1</div>
                                <div class="reminder-chip selected" data-days="3">3</div>
                                <div class="reminder-chip" data-days="5">5</div>
                                <div class="reminder-chip" data-days="7">7</div>
                            </div>
                        </div>
                        <div class="custom-date-input">
                            <span class="notification-pref-label"> Also notify on date:</span>
                            <input type="number" class="form-input" id="customNotifyDate" min="1" max="31" placeholder="--">
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
            <button type="submit" form="cardForm" class="btn btn-primary">Save Card</button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Hidden file input for import -->
<input type="file" id="fileInput" accept=".json" style="display: none;">

<script>
    // ========================================
    // APPLICATION STATE & CONFIGURATION
    // ========================================

    const APP_CONFIG = {
        storageKey: 'cardguard_cards',
        settingsKey: 'cardguard_settings',
        version: '2.2.0'
    };

    // Popular Banks with colors
    const POPULAR_BANKS = [
        { id: 'hdfc', name: 'HDFC Bank', color: '#', abbr: 'HDFC', logoUrl: 'HDFCBankLogo.png' },
        { id: 'sbi', name: 'SBI', color: '#', abbr: 'SBI', logoUrl: 'SBIBankLogo.png' },
        { id: 'icici', name: 'ICICI Bank', color: '#', abbr: 'ICICI', logoUrl: 'ICICIBankLogo.png' },
        { id: 'axis', name: 'Axis Bank', color: '#', abbr: 'AXIS', logoUrl: 'AxisBankLogo.png' },
        { id: 'kotak', name: 'Kotak', color: '#', abbr: 'KTK', logoUrl: 'KotakBankLogo.png' },
        { id: 'rbl', name: 'RBL Bank', color: '#', abbr: 'RBL', logoUrl: 'RBLBankLogo.png' },
        { id: 'indusind', name: 'IndusInd Bank', color: '#', abbr: 'IIB', logoUrl: 'IndusIndBankLogo.webp' },
        { id: 'idfc', name: 'IDFC Bank', color: '#', abbr: 'IDFC', logoUrl: 'IDFCBankLogo.png' },
        { id: 'amex', name: 'American Express', color: '#', abbr: 'AMEX', logoUrl: 'AmericanExpressBankLogo.png' },
        { id: 'yes', name: 'YES Bank', color: '#', abbr: 'YES', logoUrl: 'YESBankLogo.png' },
        { id: 'sc', name: 'Standard Chartered Bank', color: '#', abbr: 'SC', logoUrl: 'StandardCharteredBankLogo.png' },
        { id: 'citi', name: 'Citibank', color: '#', abbr: 'CITI', logoUrl: 'CitiBankLogo.png' },
        { id: 'hsbc', name: 'HSBC Bank', color: '#', abbr: 'HSBC', logoUrl: 'HSBCBankLogo.png' },
        { id: 'federal', name: 'Federal Bank', color: '#', abbr: 'FED', logoUrl: 'FederalBankLogo.webp' },
        { id: 'union', name: 'Union Bank of India', color: '#', abbr: 'UBI', logoUrl: 'UnionBankLogo.png' },
        { id: 'canara', name: 'Canara Bank', color: '#', abbr: 'CAN', logoUrl: 'CanaraBankLogo.png' },
        { id: 'pnb', name: 'PNB', color: '#', abbr: 'PNB', logoUrl: 'PNBBankLogo.png' },
        { id: 'bob', name: 'Bank of Baroda', color: '#', abbr: 'BOB', logoUrl: 'BankOfBarodaBankLogo.png' },
        { id: 'au', name: 'AU', color: '#', abbr: 'AU', logoUrl: 'AUSmallFinanceBankLogo.png' },
        { id: 'slice', name: 'Slice', color: '#', abbr: 'SLCE', logoUrl: 'SliceBankLogo.png' },
        { id: 'sbm', name: 'SBM Bank', color: '#', abbr: 'SBM', logoUrl: 'SBMBankLogo.png' },
        { id: 'unity', name: 'Unity SFB', color: '', abbr: 'UNTY', logoUrl: 'UnitySmallFinanceBankLogo.png' },
        { id: 'utkarsh', name: 'Utkarsh SFB', color: '', abbr: 'UTKS', logoUrl: 'UtkarshSmallFinanceBankLogo.png' },
        { id: 'other', name: 'Other Bank', color: '#6366f1', abbr: '...', logoUrl: null }
    ];

    // Card color gradients
    const CARD_COLORS = [
        { id: 'midnight', gradient: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)' },
        { id: 'ocean', gradient: 'linear-gradient(135deg, #0077b6 0%, #00b4d8 50%, #90e0ef 100%)' },
        { id: 'sunset', gradient: 'linear-gradient(135deg, #ff6b6b 0%, #feca57 100%)' },
        { id: 'forest', gradient: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)' },
        { id: 'purple', gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
        { id: 'rose', gradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
        { id: 'gold', gradient: 'linear-gradient(135deg, #f7971e 0%, #ffd200 100%)' },
        { id: 'slate', gradient: 'linear-gradient(135deg, #485563 0%, #29323c 100%)' },
        { id: 'royal', gradient: 'linear-gradient(135deg, #141e30 0%, #243b55 100%)' },
        { id: 'cherry', gradient: 'linear-gradient(135deg, #eb3349 0%, #f45c43 100%)' }
    ];

    // Card patterns
    const CARD_PATTERNS = ['circles', 'waves', 'grid'];

    // Default notification times
    const DEFAULT_NOTIFICATION_TIMES = {
        morning: { hour: 9, minute: 0, label: '9:00 AM', icon: '' },
        afternoon: { hour: 14, minute: 0, label: '2:00 PM', icon: '' },
        evening: { hour: 18, minute: 0, label: '6:00 PM', icon: '' }
    };

    // Application state
    let state = {
        cards: [],
        settings: {
            pushNotifications: false,
            soundAlerts: true,
            defaultReminderDays: 3,
            darkMode: false,
            notificationTimes: {
                morning: true,
                afternoon: false,
                evening: false
            },
            customTimeEnabled: false,
            customTime: '10:00',
            maxNotificationsPerDay: 2,
            urgentAlerts: true,
            consolidatedSummary: true
        },
        currentView: 'dashboard',
        editingCardId: null,
        selectedColor: CARD_COLORS[0].id,
        selectedBank: null,
        selectedReminder: 3,
        calendarDate: new Date(),
        notificationsSentToday: 0,
        lastNotificationDate: null
    };

    // PWA install prompt
    let deferredPrompt = null;

    // Scheduler interval IDs
    let schedulerIntervalId = null;
    let statusUpdateIntervalId = null;

    // Track which time slots have been used today
    let usedTimeSlots = {};

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================

    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function getDaysUntil(dayOfMonth) {
        const today = new Date();
        const currentDay = today.getDate();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();

        let targetDate = new Date(currentYear, currentMonth, dayOfMonth);

        if (dayOfMonth <= currentDay) {
            targetDate = new Date(currentYear, currentMonth + 1, dayOfMonth);
        }

        const diffTime = targetDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        return diffDays;
    }

    function getCurrentBillingCycle() {
        const today = new Date();
        return today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
    }

    function formatCurrency(amount) {
        if (!amount) return '0';
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            maximumFractionDigits: 0
        }).format(amount);
    }

    function getOrdinal(n) {
        const s = ['th', 'st', 'nd', 'rd'];
        const v = n % 100;
        return n + (s[(v - 20) % 10] || s[v] || s[0]);
    }

    function getDueStatus(daysUntil, isPaid) {
        if (isPaid) return { class: 'paid', text: ' Paid' };
        if (daysUntil <= 0) return { class: 'urgent', text: 'Due Today!' };
        if (daysUntil <= 3) return { class: 'urgent', text: daysUntil + ' day' + (daysUntil > 1 ? 's' : '') + ' left' };
        if (daysUntil <= 7) return { class: 'warning', text: daysUntil + ' days left' };
        return { class: 'safe', text: daysUntil + ' days left' };
    }

    function isCardPaidThisCycle(card) {
        const currentCycle = getCurrentBillingCycle();
        return card.paidCycles && card.paidCycles.includes(currentCycle);
    }

    function populateDateSelects() {
        const billingDateSelect = document.getElementById('billingDate');
        const dueDateSelect = document.getElementById('dueDate');

        billingDateSelect.innerHTML = '';
        dueDateSelect.innerHTML = '';

        for (let i = 1; i <= 31; i++) {
            const option1 = document.createElement('option');
            option1.value = i;
            option1.textContent = getOrdinal(i);
            billingDateSelect.appendChild(option1);

            const option2 = document.createElement('option');
            option2.value = i;
            option2.textContent = getOrdinal(i);
            dueDateSelect.appendChild(option2);
        }
    }

    function formatTime12Hour(time24) {
        if (!time24) return '--:--';
        const parts = time24.split(':');
        const hours = parseInt(parts[0]);
        const minutes = parseInt(parts[1]);
        const period = hours >= 12 ? 'PM' : 'AM';
        const hours12 = hours % 12 || 12;
        return hours12 + ':' + String(minutes).padStart(2, '0') + ' ' + period;
    }

    function getCustomTimeFromInput() {
        const input = document.getElementById('customNotificationTime');
        return input ? input.value : '';
    }

    function setCustomTimeToInput(time24) {
        if (!time24) return;
        const input = document.getElementById('customNotificationTime');
        if (input) {
            input.value = time24;
        }
    }

    function getTodayDateString() {
        return new Date().toDateString();
    }

    // ========================================
    // NETWORK LOGO IMAGES
    // ========================================

    function getNetworkLogo(network) {
        const logos = {
            visa: '<div class="network-logo"><img src="visalogo.png" alt="Visa" /></div>',
            mastercard: '<div class="network-logo"><img src="mastercardlogo.png" alt="MasterCard" /></div>',
            rupay: '<div class="network-logo"><img src="rupaylogo.png" alt="RuPay" /></div>',
            amex: '<div class="network-logo"><img src="amexlogo.png" alt="American Express" /></div>',
            diners: '<div class="network-logo"><img src="dinerslogo.png" alt="Diners Club" /></div>'
        };
        return logos[network] || logos.visa;
    }

    // ========================================
    // LOCAL STORAGE FUNCTIONS
    // ========================================

    function loadCards() {
        try {
            const data = localStorage.getItem(APP_CONFIG.storageKey);
            state.cards = data ? JSON.parse(data) : [];
        } catch (e) {
            console.error('Error loading cards:', e);
            state.cards = [];
        }
    }

    function saveCards() {
        try {
            localStorage.setItem(APP_CONFIG.storageKey, JSON.stringify(state.cards));
        } catch (e) {
            console.error('Error saving cards:', e);
            showToast('Error saving data', 'error');
        }
    }

    function loadSettings() {
        try {
            const data = localStorage.getItem(APP_CONFIG.settingsKey);
            if (data) {
                const savedSettings = JSON.parse(data);
                state.settings = {
                    ...state.settings,
                    ...savedSettings,
                    notificationTimes: {
                        ...state.settings.notificationTimes,
                        ...(savedSettings.notificationTimes || {})
                    }
                };
            }
        } catch (e) {
            console.error('Error loading settings:', e);
        }

        // Load notification tracking
        const lastNotifDate = localStorage.getItem('cardguard_lastnotifdate');
        const notifCount = localStorage.getItem('cardguard_notifcount');

        if (lastNotifDate === getTodayDateString()) {
            state.notificationsSentToday = parseInt(notifCount) || 0;
        } else {
            state.notificationsSentToday = 0;
        }
        state.lastNotificationDate = lastNotifDate;

        // Load used time slots for today
        const savedSlots = localStorage.getItem('cardguard_usedslots');
        const slotsDate = localStorage.getItem('cardguard_slotsdate');

        if (slotsDate === getTodayDateString() && savedSlots) {
            try {
                usedTimeSlots = JSON.parse(savedSlots);
            } catch (e) {
                usedTimeSlots = {};
            }
        } else {
            usedTimeSlots = {};
        }
    }

    function saveSettings() {
        try {
            localStorage.setItem(APP_CONFIG.settingsKey, JSON.stringify(state.settings));
        } catch (e) {
            console.error('Error saving settings:', e);
        }
    }

    function saveNotificationCount() {
        localStorage.setItem('cardguard_lastnotifdate', getTodayDateString());
        localStorage.setItem('cardguard_notifcount', state.notificationsSentToday.toString());
    }

    function saveUsedTimeSlots() {
        localStorage.setItem('cardguard_slotsdate', getTodayDateString());
        localStorage.setItem('cardguard_usedslots', JSON.stringify(usedTimeSlots));
    }

    // ========================================
    // NOTIFICATION SYSTEM - CORE FUNCTIONS
    // ========================================

    async function requestNotificationPermission() {
        if (!('Notification' in window)) {
            showToast('Notifications not supported in this browser', 'error');
            return false;
        }

        try {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                state.settings.pushNotifications = true;
                saveSettings();
                updateNotificationBanner();
                document.getElementById('pushNotificationsToggle').checked = true;
                showToast('Notifications enabled!', 'success');
                startNotificationScheduler();
                return true;
            } else {
                showToast('Notification permission denied', 'warning');
                return false;
            }
        } catch (e) {
            console.error('Error requesting notification permission:', e);
            return false;
        }
    }

    function getSelectedNotificationTimes() {
        const times = [];

        if (state.settings.notificationTimes.morning) {
            times.push({
                hour: DEFAULT_NOTIFICATION_TIMES.morning.hour,
                minute: DEFAULT_NOTIFICATION_TIMES.morning.minute,
                label: DEFAULT_NOTIFICATION_TIMES.morning.label,
                icon: DEFAULT_NOTIFICATION_TIMES.morning.icon,
                type: 'preset',
                id: 'morning'
            });
        }
        if (state.settings.notificationTimes.afternoon) {
            times.push({
                hour: DEFAULT_NOTIFICATION_TIMES.afternoon.hour,
                minute: DEFAULT_NOTIFICATION_TIMES.afternoon.minute,
                label: DEFAULT_NOTIFICATION_TIMES.afternoon.label,
                icon: DEFAULT_NOTIFICATION_TIMES.afternoon.icon,
                type: 'preset',
                id: 'afternoon'
            });
        }
        if (state.settings.notificationTimes.evening) {
            times.push({
                hour: DEFAULT_NOTIFICATION_TIMES.evening.hour,
                minute: DEFAULT_NOTIFICATION_TIMES.evening.minute,
                label: DEFAULT_NOTIFICATION_TIMES.evening.label,
                icon: DEFAULT_NOTIFICATION_TIMES.evening.icon,
                type: 'preset',
                id: 'evening'
            });
        }

        if (state.settings.customTimeEnabled && state.settings.customTime) {
            const parts = state.settings.customTime.split(':');
            const hour = parseInt(parts[0]);
            const minute = parseInt(parts[1]);
            times.push({
                hour: hour,
                minute: minute,
                label: formatTime12Hour(state.settings.customTime),
                icon: '',
                type: 'custom',
                id: 'custom'
            });
        }

        // Sort by time
        times.sort(function(a, b) {
            return (a.hour * 60 + a.minute) - (b.hour * 60 + b.minute);
        });

        return times;
    }

    function checkIfTimeToNotify() {
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const currentTotalMinutes = currentHour * 60 + currentMinute;

        const selectedTimes = getSelectedNotificationTimes();

        console.log(' Time Check at ' + currentHour + ':' + String(currentMinute).padStart(2, '0'));

        for (let i = 0; i < selectedTimes.length; i++) {
            const time = selectedTimes[i];
            const timeTotalMinutes = time.hour * 60 + time.minute;
            const difference = Math.abs(currentTotalMinutes - timeTotalMinutes);

            // 5-minute window to catch the notification
            if (difference <= 5) {
                const slotKey = time.id + '_' + time.hour + '_' + time.minute;

                if (usedTimeSlots[slotKey]) {
                    console.log('    Already sent for slot: ' + slotKey);
                    continue;
                }

                console.log('    MATCH! Slot: ' + slotKey);
                return { matched: true, timeSlot: time, slotKey: slotKey };
            }
        }

        console.log('    No time match');
        return { matched: false, timeSlot: null, slotKey: null };
    }

    function getCardsNeedingReminder() {
        const reminderCards = [];
        const urgentCards = [];

        console.log(' Checking ' + state.cards.length + ' cards...');

        for (let i = 0; i < state.cards.length; i++) {
            const card = state.cards[i];
            const cardName = card.cardName || card.bankName;

            if (isCardPaidThisCycle(card)) {
                console.log('    ' + cardName + ' - Paid');
                continue;
            }

            const daysUntilDue = getDaysUntil(card.dueDate);
            console.log('    ' + cardName + ' - Due in ' + daysUntilDue + ' days');

            // Urgent: due today or tomorrow
            if (daysUntilDue >= 0 && daysUntilDue <= 1) {
                console.log('      URGENT!');
                urgentCards.push({ card: card, daysUntil: daysUntilDue });
                continue;
            }

            if (card.notifyBeforeDue === false) {
                continue;
            }

            const reminderDays = card.reminderDays || [state.settings.defaultReminderDays];

            let shouldRemind = false;
            for (let j = 0; j < reminderDays.length; j++) {
                if (daysUntilDue === reminderDays[j]) {
                    shouldRemind = true;
                    break;
                }
            }

            if (!shouldRemind && daysUntilDue === state.settings.defaultReminderDays) {
                shouldRemind = true;
            }

            if (shouldRemind) {
                reminderCards.push({ card: card, daysUntil: daysUntilDue });
            }
        }

        console.log(' Urgent=' + urgentCards.length + ', Reminders=' + reminderCards.length);

        return { urgentCards: urgentCards, reminderCards: reminderCards };
    }

    function playNotificationSound(isUrgent) {
        if (!state.settings.soundAlerts) {
            return;
        }

        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;

            const audioContext = new AudioContext();

            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = isUrgent ? 880 : 660;
            oscillator.type = 'sine';

            const now = audioContext.currentTime;
            gainNode.gain.setValueAtTime(0.3, now);

            if (isUrgent) {
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.setValueAtTime(0, now + 0.15);
                gainNode.gain.setValueAtTime(0.3, now + 0.25);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.45);
                oscillator.start(now);
                oscillator.stop(now + 0.5);
            } else {
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                oscillator.start(now);
                oscillator.stop(now + 0.35);
            }

            oscillator.onended = function() {
                audioContext.close();
            };

            console.log(' Sound played');

        } catch (e) {
            console.log(' Sound error:', e.message);
        }
    }

    function sendNotification(title, body, tag, isUrgent) {
        if (Notification.permission !== 'granted') {
            console.log(' Permission not granted');
            return false;
        }

        try {
            const notification = new Notification(title, {
                body: body,
                tag: tag,
                requireInteraction: isUrgent
            });

            notification.onclick = function() {
                window.focus();
                notification.close();
            };

            setTimeout(function() {
                notification.close();
            }, 15000);

            console.log(' Notification sent: ' + title);

            playNotificationSound(isUrgent);

            state.notificationsSentToday++;
            saveNotificationCount();

            return true;

        } catch (error) {
            console.error(' Notification error:', error);
            return false;
        }
    }

    function sendConsolidatedNotification(cards, isUrgent) {
        if (cards.length === 0) return false;

        let title, body;

        if (cards.length === 1) {
            const item = cards[0];
            const card = item.card;
            const daysUntil = item.daysUntil;
            const cardName = card.cardName || card.bankName;

            if (isUrgent) {
                title = ' URGENT: ' + cardName;
                body = daysUntil === 0 ? 'Payment is due TODAY!' : 'Payment is due TOMORROW!';
            } else {
                title = ' ' + cardName + ' Reminder';
                body = 'Payment due in ' + daysUntil + ' days (' + getOrdinal(card.dueDate) + ')';
            }
        } else {
            title = isUrgent ? ' URGENT: ' + cards.length + ' Cards!' : ' ' + cards.length + ' Cards Due Soon';

            const parts = [];
            for (let i = 0; i < Math.min(cards.length, 3); i++) {
                const item = cards[i];
                parts.push((item.card.cardName || item.card.bankName) + ' (' + item.daysUntil + 'd)');
            }
            body = parts.join(', ');
            if (cards.length > 3) {
                body += ' +' + (cards.length - 3) + ' more';
            }
        }

        const tag = isUrgent ? 'urgent-' + Date.now() : 'reminder-' + Date.now();
        return sendNotification(title, body, tag, isUrgent);
    }

    // ========================================
    // NOTIFICATION SCHEDULER
    // ========================================

    function startNotificationScheduler() {
        stopNotificationScheduler();

        console.log(' Starting scheduler...');

        schedulerIntervalId = setInterval(function() {
            runScheduledCheck();
        }, 30 * 1000);

        statusUpdateIntervalId = setInterval(function() {
            updateSchedulerStatusDisplay();
        }, 1000);

        runScheduledCheck();
        updateSchedulerStatusDisplay();

        console.log(' Scheduler started');
    }

    function stopNotificationScheduler() {
        if (schedulerIntervalId) {
            clearInterval(schedulerIntervalId);
            schedulerIntervalId = null;
        }
        if (statusUpdateIntervalId) {
            clearInterval(statusUpdateIntervalId);
            statusUpdateIntervalId = null;
        }
    }

    function runScheduledCheck() {
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        const lastCheckResult = document.getElementById('lastCheckResult');

        console.log('');
        console.log(' CHECK at ' + timeString);

        if (!state.settings.pushNotifications) {
            updateLastCheckDisplay(lastCheckResult, timeString, 'Notifications disabled', 'warning');
            return;
        }

        if (Notification.permission !== 'granted') {
            updateLastCheckDisplay(lastCheckResult, timeString, 'Permission not granted', 'error');
            return;
        }

        if (state.cards.length === 0) {
            updateLastCheckDisplay(lastCheckResult, timeString, 'No cards added', 'warning');
            return;
        }

        // Reset for new day
        if (state.lastNotificationDate !== getTodayDateString()) {
            state.notificationsSentToday = 0;
            state.lastNotificationDate = getTodayDateString();
            usedTimeSlots = {};
            saveNotificationCount();
            saveUsedTimeSlots();
        }

        if (state.notificationsSentToday >= state.settings.maxNotificationsPerDay) {
            updateLastCheckDisplay(lastCheckResult, timeString, 'Max notifications reached', 'warning');
            return;
        }

        const timeCheck = checkIfTimeToNotify();

        if (!timeCheck.matched) {
            const nextTime = getNextScheduledTime(getSelectedNotificationTimes());
            updateLastCheckDisplay(lastCheckResult, timeString, 'Waiting for ' + nextTime, 'info');
            return;
        }

        // Mark slot as used
        usedTimeSlots[timeCheck.slotKey] = true;
        saveUsedTimeSlots();

        const cardsInfo = getCardsNeedingReminder();

        if (cardsInfo.urgentCards.length === 0 && cardsInfo.reminderCards.length === 0) {
            updateLastCheckDisplay(lastCheckResult, timeString, 'No cards need reminders', 'success');
            return;
        }

        console.log(' SENDING...');
        let totalSent = 0;

        if (state.settings.urgentAlerts && cardsInfo.urgentCards.length > 0) {
            if (state.settings.consolidatedSummary) {
                if (sendConsolidatedNotification(cardsInfo.urgentCards, true)) totalSent++;
            } else {
                for (let i = 0; i < cardsInfo.urgentCards.length; i++) {
                    if (state.notificationsSentToday >= state.settings.maxNotificationsPerDay) break;
                    const item = cardsInfo.urgentCards[i];
                    const title = ' URGENT: ' + (item.card.cardName || item.card.bankName);
                    const body = item.daysUntil === 0 ? 'Due TODAY!' : 'Due TOMORROW!';
                    if (sendNotification(title, body, 'urgent-' + item.card.id, true)) totalSent++;
                }
            }
        }

        if (cardsInfo.reminderCards.length > 0 && state.notificationsSentToday < state.settings.maxNotificationsPerDay) {
            if (state.settings.consolidatedSummary) {
                if (sendConsolidatedNotification(cardsInfo.reminderCards, false)) totalSent++;
            } else {
                for (let i = 0; i < cardsInfo.reminderCards.length; i++) {
                    if (state.notificationsSentToday >= state.settings.maxNotificationsPerDay) break;
                    const item = cardsInfo.reminderCards[i];
                    const title = ' ' + (item.card.cardName || item.card.bankName);
                    const body = 'Due in ' + item.daysUntil + ' days';
                    if (sendNotification(title, body, 'due-' + item.card.id, false)) totalSent++;
                }
            }
        }

        updateLastCheckDisplay(lastCheckResult, timeString, ' Sent ' + totalSent + ' notification(s)', 'success');
        showToast('Sent ' + totalSent + ' notification(s)', 'success');
    }

    function updateLastCheckDisplay(element, time, message, type) {
        if (!element) return;

        let color = 'var(--text-secondary)';
        if (type === 'success') color = '#10b981';
        if (type === 'warning') color = '#f59e0b';
        if (type === 'error') color = '#ef4444';

        element.innerHTML = ' ' + time + ' - <span style="color: ' + color + ';">' + message + '</span>';
    }

    function getNextScheduledTime(selectedTimes) {
        if (!selectedTimes || selectedTimes.length === 0) {
            return 'No times selected';
        }

        const now = new Date();
        const currentTotalMinutes = now.getHours() * 60 + now.getMinutes();

        for (let i = 0; i < selectedTimes.length; i++) {
            const time = selectedTimes[i];
            const timeTotalMinutes = time.hour * 60 + time.minute;
            const slotKey = time.id + '_' + time.hour + '_' + time.minute;

            if (timeTotalMinutes > currentTotalMinutes && !usedTimeSlots[slotKey]) {
                return time.label + ' (today)';
            }
        }

        return selectedTimes[0].label + ' (tomorrow)';
    }

    function updateSchedulerStatusDisplay() {
        const statusDot = document.getElementById('schedulerDot');
        const statusText = document.getElementById('schedulerStatusText');
        const currentTimeDisplay = document.getElementById('currentTimeDisplay');
        const notifCountDisplay = document.getElementById('notifCountDisplay');
        const maxNotifDisplay = document.getElementById('maxNotifDisplay');
        const selectedTimesDisplay = document.getElementById('selectedTimesDisplay');
        const nextCheckTime = document.getElementById('nextCheckTime');

        if (!statusDot) return;

        const now = new Date();

        if (currentTimeDisplay) {
            currentTimeDisplay.textContent = now.toLocaleTimeString();
        }

        if (notifCountDisplay) {
            notifCountDisplay.textContent = state.notificationsSentToday;
        }
        if (maxNotifDisplay) {
            maxNotifDisplay.textContent = state.settings.maxNotificationsPerDay;
        }

        if (selectedTimesDisplay) {
            const times = getSelectedNotificationTimes();
            selectedTimesDisplay.textContent = times.length === 0 ? 'None' : times.map(function(t) { return t.label; }).join(', ');
        }

        if (nextCheckTime) {
            nextCheckTime.textContent = getNextScheduledTime(getSelectedNotificationTimes());
        }

        if (state.settings.pushNotifications && Notification.permission === 'granted') {
            statusDot.style.background = '#10b981';
            statusText.textContent = 'Scheduler: Active ';
        } else if (Notification.permission === 'denied') {
            statusDot.style.background = '#ef4444';
            statusText.textContent = 'Scheduler: Blocked';
        } else {
            statusDot.style.background = '#f59e0b';
            statusText.textContent = 'Scheduler: Inactive';
        }
    }

    // ========================================
    // TEST FUNCTIONS
    // ========================================

    function testNotificationSimple() {
        console.log(' TEST: Simple notification');

        if (!('Notification' in window)) {
            alert('Notifications not supported');
            return;
        }

        if (Notification.permission === 'denied') {
            alert('Notifications BLOCKED.\n\nClick lock icon in address bar to allow.');
            return;
        }

        if (Notification.permission === 'default') {
            Notification.requestPermission().then(function(permission) {
                if (permission === 'granted') {
                    doTestNotification();
                } else {
                    alert('Permission denied');
                }
            });
        } else {
            doTestNotification();
        }
    }

    function doTestNotification() {
        try {
            const notification = new Notification(' CardGuard Test', {
                body: 'If you see this and hear a sound, notifications work!',
                tag: 'test-' + Date.now()
            });

            notification.onclick = function() {
                window.focus();
                notification.close();
            };

            playNotificationSound(false);
            showToast('Test notification sent!', 'success');

        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    function testActualReminder() {
        if (Notification.permission !== 'granted') {
            alert('Enable notifications first using "Test Simple"');
            return;
        }

        if (state.cards.length === 0) {
            alert('Add a card first');
            return;
        }

        const card = state.cards[0];
        const daysUntil = getDaysUntil(card.dueDate);
        const cardName = card.cardName || card.bankName;

        if (sendNotification(' ' + cardName + ' Reminder', 'Due in ' + daysUntil + ' days', 'test-' + Date.now(), false)) {
            showToast('Reminder sent for ' + cardName, 'success');
        }
    }

    function forceCheckNotifications() {
        let info = '=== DEBUG INFO ===\n\n';
        info += 'Permission: ' + Notification.permission + '\n';
        info += 'Enabled: ' + state.settings.pushNotifications + '\n';
        info += 'Cards: ' + state.cards.length + '\n';
        info += 'Sent today: ' + state.notificationsSentToday + '/' + state.settings.maxNotificationsPerDay + '\n\n';

        const times = getSelectedNotificationTimes();
        info += 'Times: ' + times.map(function(t) { return t.label; }).join(', ') + '\n';

        const cardsInfo = getCardsNeedingReminder();
        info += 'Urgent: ' + cardsInfo.urgentCards.length + '\n';
        info += 'Reminders: ' + cardsInfo.reminderCards.length;

        alert(info);

        if (Notification.permission === 'granted') {
            const allCards = cardsInfo.urgentCards.concat(cardsInfo.reminderCards);
            if (allCards.length > 0) {
                sendConsolidatedNotification(allCards, cardsInfo.urgentCards.length > 0);
                showToast('Force sent notification!', 'success');
            } else {
                showToast('No cards need reminders', 'info');
            }
        }
    }

    // ========================================
    // NOTIFICATION SCHEDULE UI
    // ========================================

    function updateSchedulePreview() {
        const timesList = document.getElementById('scheduleTimesList');
        const datesList = document.getElementById('scheduledDatesList');
        const previewText = document.getElementById('previewText');

        if (!timesList || !previewText) return;

        const selectedTimes = getSelectedNotificationTimes();

        // Times list
        if (selectedTimes.length === 0) {
            timesList.innerHTML = '<span class="schedule-time-tag">No times selected</span>';
        } else {
            let html = '';
            for (let i = 0; i < selectedTimes.length; i++) {
                const time = selectedTimes[i];
                const cssClass = time.type === 'custom' ? 'custom' : 'active';
                html += '<span class="schedule-time-tag ' + cssClass + '">' + time.icon + ' ' + time.label + '</span>';
            }
            timesList.innerHTML = html;
        }

        // Dates list
        if (datesList) {
            const scheduledDates = getScheduledNotificationDates();

            if (scheduledDates.length === 0) {
                datesList.innerHTML = '<div class="no-scheduled-dates"><div class="icon"></div><div>No upcoming notifications</div></div>';
            } else {
                let html = '';
                for (let i = 0; i < scheduledDates.length; i++) {
                    const item = scheduledDates[i];
                    let urgencyClass = '';
                    let icon = '';

                    if (item.daysUntil <= 0) { urgencyClass = 'urgent'; icon = ''; }
                    else if (item.daysUntil === 1) { urgencyClass = 'urgent'; icon = ''; }
                    else if (item.daysUntil <= 3) { urgencyClass = 'warning'; icon = ''; }

                    html += '<div class="scheduled-date-item ' + urgencyClass + '">';
                    html += '<div class="scheduled-date-info"><span class="scheduled-date-icon">' + icon + '</span>';
                    html += '<span class="scheduled-date-text">' + item.dateFormatted + ' - ' + item.reason + '</span></div>';
                    html += '<span class="scheduled-date-card">' + item.cardName + '</span></div>';
                }
                datesList.innerHTML = html;
            }
        }

        // Preview text
        const cardsInfo = getCardsNeedingReminder();
        const allCards = cardsInfo.urgentCards.concat(cardsInfo.reminderCards);

        if (allCards.length === 0) {
            previewText.textContent = 'No upcoming reminders. All cards paid! ';
        } else if (state.settings.consolidatedSummary && allCards.length > 1) {
            const parts = [];
            for (let i = 0; i < Math.min(allCards.length, 3); i++) {
                parts.push((allCards[i].card.cardName || allCards[i].card.bankName) + ' (' + allCards[i].daysUntil + 'd)');
            }
            previewText.textContent = allCards.length + ' cards due: ' + parts.join(', ') + (allCards.length > 3 ? '...' : '');
        } else if (allCards.length > 0) {
            const item = allCards[0];
            const name = item.card.cardName || item.card.bankName;
            previewText.textContent = item.daysUntil === 0 ? name + ' due TODAY!' : name + ' due in ' + item.daysUntil + ' day(s)';
        }
    }

    function getScheduledNotificationDates() {
        const dates = [];
        const today = new Date();

        for (let i = 0; i < state.cards.length; i++) {
            const card = state.cards[i];
            if (isCardPaidThisCycle(card)) continue;

            const daysUntilDue = getDaysUntil(card.dueDate);
            const cardName = card.cardName || card.bankName;

            if (state.settings.urgentAlerts) {
                if (daysUntilDue === 0) {
                    dates.push({ dateFormatted: 'Today', daysUntil: 0, reason: ' DUE TODAY!', cardName: cardName });
                } else if (daysUntilDue === 1) {
                    dates.push({ dateFormatted: 'Tomorrow', daysUntil: 1, reason: ' Due Tomorrow', cardName: cardName });
                }
            }

            if (card.notifyBeforeDue !== false) {
                const reminderDays = card.reminderDays || [state.settings.defaultReminderDays];
                for (let j = 0; j < reminderDays.length; j++) {
                    if (daysUntilDue === reminderDays[j] && daysUntilDue > 1) {
                        dates.push({ dateFormatted: 'Today', daysUntil: daysUntilDue, reason: reminderDays[j] + ' days before', cardName: cardName });
                    }
                }
            }
        }

        dates.sort(function(a, b) { return a.daysUntil - b.daysUntil; });
        return dates.slice(0, 10);
    }

    function formatDateShort(date) {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        if (date.toDateString() === today.toDateString()) return 'Today';
        if (date.toDateString() === tomorrow.toDateString()) return 'Tomorrow';
        return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    // ========================================
    // UI RENDERING FUNCTIONS
    // ========================================

    function renderBankSelector() {
        const selector = document.getElementById('bankSelector');
        let html = '';

        for (let i = 0; i < POPULAR_BANKS.length; i++) {
            const bank = POPULAR_BANKS[i];
            const selected = state.selectedBank === bank.id ? 'selected' : '';
            let logoContent = bank.logoUrl ? '<img src="' + bank.logoUrl + '" alt="' + bank.abbr + '" style="width:100%;height:100%;object-fit:contain;border-radius:8px;">' : bank.abbr;

            html += '<div class="bank-option ' + selected + '" data-bank="' + bank.id + '" onclick="selectBank(\'' + bank.id + '\')">';
            html += '<div class="bank-option-logo" style="background:' + bank.color + ';">' + logoContent + '</div>';
            html += '<span class="bank-option-name">' + bank.name + '</span></div>';
        }

        selector.innerHTML = html;
    }

    function selectBank(bankId) {
        state.selectedBank = bankId;
        const options = document.querySelectorAll('.bank-option');
        for (let i = 0; i < options.length; i++) {
            options[i].classList.toggle('selected', options[i].dataset.bank === bankId);
        }

        const otherInput = document.getElementById('otherBankInput');
        if (bankId === 'other') {
            otherInput.classList.add('show');
            document.getElementById('customBankName').focus();
        } else {
            otherInput.classList.remove('show');
        }
    }

    function getBankInfo(card) {
        if (card.bankId && card.bankId !== 'other') {
            for (let i = 0; i < POPULAR_BANKS.length; i++) {
                if (POPULAR_BANKS[i].id === card.bankId) return POPULAR_BANKS[i];
            }
        }
        return { name: card.bankName, color: '#6366f1', abbr: card.bankName ? card.bankName.substring(0, 3).toUpperCase() : 'UNK', logoUrl: null };
    }

    function renderCards() {
        const grid = document.getElementById('cardsGrid');

        if (state.cards.length === 0) {
            grid.innerHTML = '<div class="add-card-btn" onclick="openAddCardModal()"><div class="icon"></div><span>Add Your First Card</span></div>';
            updateStats();
            return;
        }

        const sortedCards = state.cards.slice().sort(function(a, b) {
            const aIsPaid = isCardPaidThisCycle(a);
            const bIsPaid = isCardPaidThisCycle(b);
            if (aIsPaid !== bIsPaid) return aIsPaid ? 1 : -1;
            return getDaysUntil(a.dueDate) - getDaysUntil(b.dueDate);
        });

        let html = '';
        for (let i = 0; i < sortedCards.length; i++) {
            html += createCardHTML(sortedCards[i]);
        }

        html += '<div class="card-wrapper"><div class="add-card-btn" onclick="openAddCardModal()"><div class="icon"></div><span>Add New Card</span></div></div>';
        grid.innerHTML = html;
        updateStats();
    }

    function createCardHTML(card) {
        const colorConfig = CARD_COLORS.find(function(c) { return c.id === card.color; }) || CARD_COLORS[0];
        const bankInfo = getBankInfo(card);
        const daysUntilDue = getDaysUntil(card.dueDate);
        const isPaid = isCardPaidThisCycle(card);
        const dueStatus = getDueStatus(daysUntilDue, isPaid);
        const pattern = CARD_PATTERNS[Math.floor(card.id.charCodeAt(0) % CARD_PATTERNS.length)];
        const networkLogo = getNetworkLogo(card.network);
        const isUrgent = !isPaid && daysUntilDue <= 1;
        const urgentClass = isUrgent ? 'urgent-pulse' : '';

        let logoContent = bankInfo.logoUrl ? '<img src="' + bankInfo.logoUrl + '" alt="' + bankInfo.abbr + '" style="width:100%;height:100%;object-fit:contain;border-radius:8px;">' : bankInfo.abbr;

        let html = '<div class="card-wrapper">';
        html += '<div class="credit-card ' + urgentClass + '" style="background:' + colorConfig.gradient + ';" onclick="openEditCardModal(\'' + card.id + '\')">';
        html += '<div class="card-pattern ' + pattern + '"></div>';
        html += '<div class="due-badge ' + dueStatus.class + '">' + dueStatus.text + '</div>';
        html += '<div class="card-actions">';
        html += '<button class="card-action-btn" onclick="event.stopPropagation();openEditCardModal(\'' + card.id + '\')" title="Edit"></button>';
        html += '<button class="card-action-btn" onclick="event.stopPropagation();deleteCard(\'' + card.id + '\')" title="Delete"></button>';
        html += '</div>';
        html += '<div class="card-header"><div class="card-bank-info">';
        html += '<div class="bank-logo" style="background:' + bankInfo.color + ';">' + logoContent + '</div>';
        html += '<span class="card-bank">' + bankInfo.name + '</span></div>';
        html += '<div class="card-chip"></div></div>';
        html += '<div class="card-number">   ' + card.last4Digits + '</div>';
        html += '<div class="card-footer"><div class="card-info">';
        html += '<div class="card-holder-name">' + (card.cardHolderName || 'CARD HOLDER') + '</div>';
        if (card.cardName) html += '<div class="card-name">' + card.cardName + '</div>';
        html += '<div class="card-dates">';
        html += '<div class="card-date-item"><span>Bill Date</span>' + getOrdinal(card.billingDate) + '</div>';
        html += '<div class="card-date-item"><span>Due Date</span>' + getOrdinal(card.dueDate) + '</div>';
        html += '</div></div><div class="card-network">' + networkLogo + '</div></div></div>';
        html += '<div class="payment-actions"><button class="mark-paid-btn ' + (isPaid ? 'paid' : '') + '" onclick="togglePaidStatus(\'' + card.id + '\')">';
        html += isPaid ? ' Paid for this month' : ' Mark as Paid';
        html += '</button></div></div>';

        return html;
    }

    function togglePaidStatus(cardId) {
        let card = null;
        for (let i = 0; i < state.cards.length; i++) {
            if (state.cards[i].id === cardId) { card = state.cards[i]; break; }
        }
        if (!card) return;

        const currentCycle = getCurrentBillingCycle();
        if (!card.paidCycles) card.paidCycles = [];

        const idx = card.paidCycles.indexOf(currentCycle);
        if (idx === -1) {
            card.paidCycles.push(currentCycle);
            showToast((card.cardName || card.bankName) + ' marked as paid! ', 'success');
        } else {
            card.paidCycles.splice(idx, 1);
            showToast((card.cardName || card.bankName) + ' marked as unpaid', 'info');
        }

        saveCards();
        renderCards();
        renderTimeline();
        updateSchedulePreview();
    }

    function updateStats() {
        document.getElementById('totalCards').textContent = state.cards.length;

        let dueSoon = 0, billingSoon = 0, paid = 0;
        for (let i = 0; i < state.cards.length; i++) {
            const card = state.cards[i];
            if (isCardPaidThisCycle(card)) { paid++; }
            else if (getDaysUntil(card.dueDate) <= 3) { dueSoon++; }
            if (getDaysUntil(card.billingDate) <= 3) { billingSoon++; }
        }

        document.getElementById('dueSoon').textContent = dueSoon;
        document.getElementById('billingSoon').textContent = billingSoon;
        document.getElementById('paidCount').textContent = paid;
    }

    function renderTimeline() {
        const timeline = document.getElementById('timeline');

        if (state.cards.length === 0) {
            timeline.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><h3>No Upcoming Dates</h3><p>Add credit cards to see their due dates here</p></div>';
            return;
        }

        const events = [];
        for (let i = 0; i < state.cards.length; i++) {
            const card = state.cards[i];
            events.push({ type: 'billing', card: card, daysUntil: getDaysUntil(card.billingDate), date: card.billingDate, isPaid: false });
            events.push({ type: 'due', card: card, daysUntil: getDaysUntil(card.dueDate), date: card.dueDate, isPaid: isCardPaidThisCycle(card) });
        }

        events.sort(function(a, b) { return a.daysUntil - b.daysUntil; });

        const upcoming = events.filter(function(e) { return e.daysUntil >= 0 && e.daysUntil <= 14; });

        if (upcoming.length === 0) {
            timeline.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><h3>All Clear!</h3><p>No due dates in the next 14 days</p></div>';
            return;
        }

        let html = '';
        for (let i = 0; i < upcoming.length; i++) {
            const e = upcoming[i];
            let statusClass = e.isPaid ? 'paid' : (e.daysUntil <= 3 ? 'urgent' : (e.daysUntil <= 7 ? 'warning' : ''));
            const icon = e.type === 'due' ? '' : '';
            const typeText = e.type === 'due' ? 'Payment Due' : 'Billing Date';
            const dayText = e.daysUntil === 0 ? 'Today' : (e.daysUntil === 1 ? 'Tomorrow' : 'In ' + e.daysUntil + ' days');

            html += '<div class="timeline-item ' + statusClass + '"><div class="timeline-card">';
            html += '<div class="timeline-date">' + dayText + '  ' + getOrdinal(e.date) + '</div>';
            html += '<div class="timeline-title">' + icon + ' ' + (e.card.cardName || e.card.bankName) + ' - ' + typeText;
            if (e.isPaid) html += '<span class="paid-badge">PAID</span>';
            html += '</div><div class="timeline-subtitle">' + e.card.bankName + '  ' + e.card.last4Digits + '</div></div></div>';
        }

        timeline.innerHTML = html;
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const monthLabel = document.getElementById('calendarMonth');

        const year = state.calendarDate.getFullYear();
        const month = state.calendarDate.getMonth();
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        monthLabel.textContent = monthNames[month] + ' ' + year;

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startingDay = firstDay.getDay();
        const totalDays = lastDay.getDate();
        const today = new Date();
        const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;

        const dueDates = [], billingDates = [];
        for (let i = 0; i < state.cards.length; i++) {
            dueDates.push(state.cards[i].dueDate);
            billingDates.push(state.cards[i].billingDate);
        }

        let html = '';
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        for (let i = 0; i < dayNames.length; i++) html += '<div class="calendar-day-header">' + dayNames[i] + '</div>';

        const prevMonth = new Date(year, month, 0);
        for (let i = startingDay - 1; i >= 0; i--) html += '<div class="calendar-day other-month">' + (prevMonth.getDate() - i) + '</div>';

        for (let day = 1; day <= totalDays; day++) {
            const isToday = isCurrentMonth && day === today.getDate();
            const hasDue = dueDates.indexOf(day) !== -1;
            const hasBilling = billingDates.indexOf(day) !== -1 && !hasDue;
            let classes = 'calendar-day';
            if (isToday) classes += ' today';
            if (hasDue) classes += ' has-due';
            if (hasBilling) classes += ' has-billing';
            html += '<div class="' + classes + '">' + day + '</div>';
        }

        const remaining = 42 - (startingDay + totalDays);
        for (let day = 1; day <= remaining; day++) html += '<div class="calendar-day other-month">' + day + '</div>';

        grid.innerHTML = html;
    }

    function renderColorPicker() {
        const picker = document.getElementById('colorPicker');
        let html = '';
        for (let i = 0; i < CARD_COLORS.length; i++) {
            const c = CARD_COLORS[i];
            html += '<div class="color-option ' + (c.id === state.selectedColor ? 'selected' : '') + '" style="background:' + c.gradient + ';" data-color="' + c.id + '" onclick="selectColor(\'' + c.id + '\')"></div>';
        }
        picker.innerHTML = html;
    }

    function updateNotificationBanner() {
        const banner = document.getElementById('notificationBanner');
        if (!('Notification' in window) || Notification.permission === 'granted') {
            banner.classList.add('hidden');
        } else {
            banner.classList.remove('hidden');
        }
    }

    // ========================================
    // MODAL FUNCTIONS
    // ========================================

    function openAddCardModal() {
        state.editingCardId = null;
        state.selectedColor = CARD_COLORS[0].id;
        state.selectedBank = null;
        state.selectedReminder = 3;

        document.getElementById('modalTitle').textContent = 'Add New Card';
        document.getElementById('cardForm').reset();
        document.getElementById('cardId').value = '';
        document.getElementById('notifyOnBilling').checked = false;
        document.getElementById('notifyBeforeDue').checked = true;
        document.getElementById('customNotifyDate').value = '';
        document.getElementById('otherBankInput').classList.remove('show');

        renderColorPicker();
        renderBankSelector();
        updateReminderSelection();
        document.getElementById('cardModal').classList.add('active');
    }

    function openEditCardModal(cardId) {
        let card = null;
        for (let i = 0; i < state.cards.length; i++) {
            if (state.cards[i].id === cardId) { card = state.cards[i]; break; }
        }
        if (!card) return;

        state.editingCardId = cardId;
        state.selectedColor = card.color;
        state.selectedBank = card.bankId || null;
        state.selectedReminder = (card.reminderDays && card.reminderDays[0]) || 3;

        document.getElementById('modalTitle').textContent = 'Edit Card';
        document.getElementById('cardId').value = card.id;
        document.getElementById('cardHolderName').value = card.cardHolderName || '';
        document.getElementById('cardName').value = card.cardName || '';
        document.getElementById('cardNetwork').value = card.network;
        document.getElementById('last4Digits').value = card.last4Digits;
        document.getElementById('creditLimit').value = card.creditLimit || '';
        document.getElementById('billingDate').value = card.billingDate;
        document.getElementById('dueDate').value = card.dueDate;
        document.getElementById('notifyOnBilling').checked = card.notifyOnBilling || false;
        document.getElementById('notifyBeforeDue').checked = card.notifyBeforeDue !== false;
        document.getElementById('customNotifyDate').value = card.customNotifyDate || '';

        if (card.bankId === 'other') {
            document.getElementById('customBankName').value = card.bankName;
            document.getElementById('otherBankInput').classList.add('show');
        } else {
            document.getElementById('customBankName').value = '';
            document.getElementById('otherBankInput').classList.remove('show');
        }

        renderColorPicker();
        renderBankSelector();
        updateReminderSelection();
        document.getElementById('cardModal').classList.add('active');
    }

    function closeCardModal() {
        document.getElementById('cardModal').classList.remove('active');
        state.editingCardId = null;
    }

    function selectColor(colorId) {
        state.selectedColor = colorId;
        const options = document.querySelectorAll('.color-option');
        for (let i = 0; i < options.length; i++) {
            options[i].classList.toggle('selected', options[i].dataset.color === colorId);
        }
    }

    function selectReminder(days) {
        state.selectedReminder = days;
        updateReminderSelection();
    }

    function updateReminderSelection() {
        const chips = document.querySelectorAll('.reminder-chip');
        for (let i = 0; i < chips.length; i++) {
            chips[i].classList.toggle('selected', parseInt(chips[i].dataset.days) === state.selectedReminder);
        }
    }

    // ========================================
    // CARD CRUD OPERATIONS
    // ========================================

    function saveCard(event) {
        event.preventDefault();

        if (!state.selectedBank) {
            showToast('Please select a bank', 'warning');
            return;
        }

        let bankName = '';
        if (state.selectedBank === 'other') {
            bankName = document.getElementById('customBankName').value.trim();
            if (!bankName) { showToast('Please enter bank name', 'warning'); return; }
        } else {
            for (let i = 0; i < POPULAR_BANKS.length; i++) {
                if (POPULAR_BANKS[i].id === state.selectedBank) { bankName = POPULAR_BANKS[i].name; break; }
            }
        }

        const existingCard = state.editingCardId ? state.cards.find(function(c) { return c.id === state.editingCardId; }) : null;

        const cardData = {
            id: document.getElementById('cardId').value || generateId(),
            cardHolderName: document.getElementById('cardHolderName').value.trim(),
            cardName: document.getElementById('cardName').value.trim(),
            bankId: state.selectedBank,
            bankName: bankName,
            network: document.getElementById('cardNetwork').value,
            last4Digits: document.getElementById('last4Digits').value,
            creditLimit: parseInt(document.getElementById('creditLimit').value) || 0,
            billingDate: parseInt(document.getElementById('billingDate').value),
            dueDate: parseInt(document.getElementById('dueDate').value),
            color: state.selectedColor,
            notifyOnBilling: document.getElementById('notifyOnBilling').checked,
            notifyBeforeDue: document.getElementById('notifyBeforeDue').checked,
            reminderDays: [state.selectedReminder],
            customNotifyDate: parseInt(document.getElementById('customNotifyDate').value) || null,
            paidCycles: existingCard ? (existingCard.paidCycles || []) : [],
            createdAt: existingCard ? existingCard.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (state.editingCardId) {
            for (let i = 0; i < state.cards.length; i++) {
                if (state.cards[i].id === state.editingCardId) { state.cards[i] = cardData; break; }
            }
            showToast('Card updated!', 'success');
        } else {
            state.cards.push(cardData);
            showToast('Card added!', 'success');
        }

        saveCards();
        closeCardModal();
        renderCards();
        renderTimeline();
        renderCalendar();
        updateSchedulePreview();
    }

    function deleteCard(cardId) {
        if (!confirm('Delete this card?')) return;
        state.cards = state.cards.filter(function(c) { return c.id !== cardId; });
        saveCards();
        renderCards();
        renderTimeline();
        renderCalendar();
        updateSchedulePreview();
        showToast('Card deleted', 'success');
    }

    // ========================================
    // DATA IMPORT/EXPORT
    // ========================================

    function exportData() {
        const data = { version: APP_CONFIG.version, exportDate: new Date().toISOString(), cards: state.cards, settings: state.settings };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'cardguard-backup-' + new Date().toISOString().split('T')[0] + '.json';
        a.click();
        URL.revokeObjectURL(url);
        showToast('Data exported!', 'success');
    }

    function importData() {
        document.getElementById('fileInput').click();
    }

    function handleFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data.cards && Array.isArray(data.cards)) {
                    if (confirm('Replace all existing cards?')) {
                        state.cards = data.cards;
                    } else {
                        for (let i = 0; i < data.cards.length; i++) {
                            let exists = false;
                            for (let j = 0; j < state.cards.length; j++) {
                                if (state.cards[j].id === data.cards[i].id) { exists = true; break; }
                            }
                            if (!exists) state.cards.push(data.cards[i]);
                        }
                    }
                    if (data.settings) {
                        state.settings = { ...state.settings, ...data.settings, notificationTimes: { ...state.settings.notificationTimes, ...(data.settings.notificationTimes || {}) } };
                        saveSettings();
                    }
                    saveCards();
                    renderCards();
                    renderTimeline();
                    renderCalendar();
                    applyTheme();
                    updateSettingsUI();
                    updateSchedulePreview();
                    showToast('Imported ' + data.cards.length + ' cards!', 'success');
                } else {
                    throw new Error('Invalid format');
                }
            } catch (error) {
                showToast('Error importing file', 'error');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    function clearAllData() {
        if (!confirm('Delete ALL cards and settings?')) return;
        if (!confirm('Last chance - delete everything?')) return;

        state.cards = [];
        state.settings = { pushNotifications: false, soundAlerts: true, defaultReminderDays: 3, darkMode: false, notificationTimes: { morning: true, afternoon: false, evening: false }, customTimeEnabled: false, customTime: '10:00', maxNotificationsPerDay: 2, urgentAlerts: true, consolidatedSummary: true };

        localStorage.removeItem(APP_CONFIG.storageKey);
        localStorage.removeItem(APP_CONFIG.settingsKey);
        localStorage.removeItem('cardguard_lastnotifdate');
        localStorage.removeItem('cardguard_notifcount');
        localStorage.removeItem('cardguard_slotsdate');
        localStorage.removeItem('cardguard_usedslots');

        usedTimeSlots = {};
        saveCards();
        saveSettings();
        applyTheme();
        renderCards();
        renderTimeline();
        renderCalendar();
        updateSettingsUI();
        updateSchedulePreview();
        showToast('All data cleared', 'success');
    }

    // ========================================
    // THEME MANAGEMENT
    // ========================================

    function toggleTheme() {
        state.settings.darkMode = !state.settings.darkMode;
        saveSettings();
        applyTheme();
        document.getElementById('darkModeToggle').checked = state.settings.darkMode;
    }

    function applyTheme() {
        if (state.settings.darkMode) {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('themeToggle').textContent = '';
        } else {
            document.documentElement.removeAttribute('data-theme');
            document.getElementById('themeToggle').textContent = '';
        }
    }

    // ========================================
    // VIEW NAVIGATION
    // ========================================

    function switchView(viewName) {
        state.currentView = viewName;

        const tabs = document.querySelectorAll('.nav-tab');
        for (let i = 0; i < tabs.length; i++) tabs[i].classList.toggle('active', tabs[i].dataset.view === viewName);

        const views = document.querySelectorAll('.view');
        for (let i = 0; i < views.length; i++) views[i].classList.toggle('active', views[i].id === viewName + 'View');

        if (viewName === 'timeline') renderTimeline();
        else if (viewName === 'calendar') renderCalendar();
        else if (viewName === 'settings') { updateSchedulePreview(); updateSchedulerStatusDisplay(); }
    }

    // ========================================
    // TOAST NOTIFICATIONS
    // ========================================

    function showToast(message, type) {
        type = type || 'info';
        const container = document.getElementById('toastContainer');
        const icons = { success: '', error: '', warning: '', info: '' };

        const toast = document.createElement('div');
        toast.className = 'toast ' + type;
        toast.innerHTML = '<span class="toast-icon">' + icons[type] + '</span><span class="toast-message">' + message + '</span>';

        container.appendChild(toast);
        setTimeout(function() { toast.classList.add('show'); }, 10);
        setTimeout(function() { toast.classList.remove('show'); setTimeout(function() { toast.remove(); }, 300); }, 4000);
    }

    // ========================================
    // SETTINGS UI
    // ========================================

    function updateSettingsUI() {
        document.getElementById('pushNotificationsToggle').checked = state.settings.pushNotifications;
        document.getElementById('soundAlertsToggle').checked = state.settings.soundAlerts;
        document.getElementById('defaultReminderDays').value = state.settings.defaultReminderDays;
        document.getElementById('darkModeToggle').checked = state.settings.darkMode;

        const t9 = document.getElementById('notifyTime9AM'); if (t9) t9.checked = state.settings.notificationTimes.morning;
        const t2 = document.getElementById('notifyTime2PM'); if (t2) t2.checked = state.settings.notificationTimes.afternoon;
        const t6 = document.getElementById('notifyTime6PM'); if (t6) t6.checked = state.settings.notificationTimes.evening;

        document.getElementById('enableCustomTime').checked = state.settings.customTimeEnabled;
        setCustomTimeToInput(state.settings.customTime);

        const wrapper = document.getElementById('customTimeWrapper');
        if (state.settings.customTimeEnabled) wrapper.classList.add('show');
        else wrapper.classList.remove('show');

        const freqBtns = document.querySelectorAll('.freq-btn');
        for (let i = 0; i < freqBtns.length; i++) freqBtns[i].classList.toggle('active', parseInt(freqBtns[i].dataset.freq) === state.settings.maxNotificationsPerDay);

        document.getElementById('urgentAlertsToggle').checked = state.settings.urgentAlerts;
        document.getElementById('consolidatedSummaryToggle').checked = state.settings.consolidatedSummary;

        updateSchedulePreview();
    }

    // ========================================
    // PWA INSTALLATION
    // ========================================

    function handleInstallPrompt(e) {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installPwaBtn').style.display = 'block';
    }

    function installPWA() {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(function(result) {
            if (result.outcome === 'accepted') showToast('App installed!', 'success');
            deferredPrompt = null;
            document.getElementById('installPwaBtn').style.display = 'none';
        });
    }

    // ========================================
    // SERVICE WORKER REGISTRATION
    // ========================================

    function registerServiceWorker() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(function(reg) {
                console.log('SW registered:', reg.scope);
            }).catch(function(err) {
                console.log('SW failed:', err);
            });
        }
    }

    // ========================================
    // EVENT LISTENERS
    // ========================================

    function initEventListeners() {
        // Navigation
        const tabs = document.querySelectorAll('.nav-tab');
        for (let i = 0; i < tabs.length; i++) {
            tabs[i].addEventListener('click', function() { switchView(this.dataset.view); });
        }

        // Theme
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);

        // Notification banner
        document.getElementById('enableNotificationsBtn').addEventListener('click', requestNotificationPermission);

        // Card form
        document.getElementById('cardForm').addEventListener('submit', saveCard);

        // Modal
        document.getElementById('closeModal').addEventListener('click', closeCardModal);
        document.getElementById('cancelBtn').addEventListener('click', closeCardModal);
        document.getElementById('cardModal').addEventListener('click', function(e) { if (e.target.id === 'cardModal') closeCardModal(); });

        // Reminder chips
        const chips = document.querySelectorAll('.reminder-chip');
        for (let i = 0; i < chips.length; i++) {
            chips[i].addEventListener('click', function() { selectReminder(parseInt(this.dataset.days)); });
        }

        // Calendar
        document.getElementById('prevMonth').addEventListener('click', function() { state.calendarDate.setMonth(state.calendarDate.getMonth() - 1); renderCalendar(); });
        document.getElementById('nextMonth').addEventListener('click', function() { state.calendarDate.setMonth(state.calendarDate.getMonth() + 1); renderCalendar(); });
        document.getElementById('todayBtn').addEventListener('click', function() { state.calendarDate = new Date(); renderCalendar(); });

        // Push toggle
        document.getElementById('pushNotificationsToggle').addEventListener('change', function(e) {
            if (e.target.checked) {
                requestNotificationPermission().then(function(granted) {
                    e.target.checked = granted;
                    if (granted) startNotificationScheduler();
                    updateSchedulerStatusDisplay();
                });
            } else {
                state.settings.pushNotifications = false;
                saveSettings();
                stopNotificationScheduler();
                showToast('Notifications disabled', 'info');
                updateSchedulerStatusDisplay();
            }
        });

        // Sound toggle
        document.getElementById('soundAlertsToggle').addEventListener('change', function(e) {
            state.settings.soundAlerts = e.target.checked;
            saveSettings();
        });

        // Default reminder
        document.getElementById('defaultReminderDays').addEventListener('change', function(e) {
            state.settings.defaultReminderDays = parseInt(e.target.value);
            saveSettings();
            updateSchedulePreview();
        });

        // Dark mode
        document.getElementById('darkModeToggle').addEventListener('change', toggleTheme);

        // Time checkboxes
        const t9 = document.getElementById('notifyTime9AM');
        if (t9) t9.addEventListener('change', function(e) { state.settings.notificationTimes.morning = e.target.checked; saveSettings(); updateSchedulePreview(); });

        const t2 = document.getElementById('notifyTime2PM');
        if (t2) t2.addEventListener('change', function(e) { state.settings.notificationTimes.afternoon = e.target.checked; saveSettings(); updateSchedulePreview(); });

        const t6 = document.getElementById('notifyTime6PM');
        if (t6) t6.addEventListener('change', function(e) { state.settings.notificationTimes.evening = e.target.checked; saveSettings(); updateSchedulePreview(); });

        // Custom time toggle
        document.getElementById('enableCustomTime').addEventListener('change', function(e) {
            state.settings.customTimeEnabled = e.target.checked;
            const wrapper = document.getElementById('customTimeWrapper');
            if (e.target.checked) wrapper.classList.add('show');
            else wrapper.classList.remove('show');
            saveSettings();
            updateSchedulePreview();
        });

        // Custom time input
        const customInput = document.getElementById('customNotificationTime');
        if (customInput) {
            customInput.addEventListener('change', function(e) {
                state.settings.customTime = e.target.value;
                saveSettings();
                updateSchedulePreview();
                showToast('Custom time: ' + formatTime12Hour(state.settings.customTime), 'success');
            });
        }

        // Frequency buttons
        const freqBtns = document.querySelectorAll('.freq-btn');
        for (let i = 0; i < freqBtns.length; i++) {
            freqBtns[i].addEventListener('click', function() {
                const freq = parseInt(this.dataset.freq);
                state.settings.maxNotificationsPerDay = freq;
                const allBtns = document.querySelectorAll('.freq-btn');
                for (let j = 0; j < allBtns.length; j++) allBtns[j].classList.toggle('active', parseInt(allBtns[j].dataset.freq) === freq);
                saveSettings();
                showToast('Max ' + freq + '/day', 'info');
            });
        }

        // Urgent alerts
        document.getElementById('urgentAlertsToggle').addEventListener('change', function(e) {
            state.settings.urgentAlerts = e.target.checked;
            saveSettings();
        });

        // Consolidated summary
        document.getElementById('consolidatedSummaryToggle').addEventListener('change', function(e) {
            state.settings.consolidatedSummary = e.target.checked;
            saveSettings();
            updateSchedulePreview();
        });

        // Data buttons
        document.getElementById('exportBtn').addEventListener('click', exportData);
        document.getElementById('importBtn').addEventListener('click', importData);
        document.getElementById('exportDataBtn').addEventListener('click', exportData);
        document.getElementById('importDataBtn').addEventListener('click', importData);
        document.getElementById('clearDataBtn').addEventListener('click', clearAllData);

        // File input
        document.getElementById('fileInput').addEventListener('change', handleFileImport);

        // PWA
        document.getElementById('installPwaBtn').addEventListener('click', installPWA);
        window.addEventListener('beforeinstallprompt', handleInstallPrompt);

        // Keyboard
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeCardModal();
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') { e.preventDefault(); openAddCardModal(); }
        });

        // Visibility change
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                if (state.lastNotificationDate !== getTodayDateString()) {
                    state.notificationsSentToday = 0;
                    state.lastNotificationDate = getTodayDateString();
                    usedTimeSlots = {};
                    saveNotificationCount();
                    saveUsedTimeSlots();
                }
                renderCards();
                updateSchedulePreview();
                if (state.settings.pushNotifications && Notification.permission === 'granted') {
                    runScheduledCheck();
                }
            }
        });

        // Before unload
        window.addEventListener('beforeunload', function() {
            saveSettings();
            saveCards();
            saveNotificationCount();
            saveUsedTimeSlots();
        });
    }

    // ========================================
    // INITIALIZATION
    // ========================================

    function init() {
        console.log(' CardGuard v' + APP_CONFIG.version + ' starting...');

        populateDateSelects();
        loadCards();
        loadSettings();
        applyTheme();
        renderCards();
        renderTimeline();
        renderCalendar();
        renderColorPicker();
        renderBankSelector();
        updateSettingsUI();
        updateNotificationBanner();
        updateSchedulePreview();
        initEventListeners();
        registerServiceWorker();

        if (state.settings.pushNotifications && Notification.permission === 'granted') {
            startNotificationScheduler();
            console.log(' Scheduler started');
        } else {
            if (statusUpdateIntervalId) clearInterval(statusUpdateIntervalId);
            statusUpdateIntervalId = setInterval(function() { updateSchedulerStatusDisplay(); }, 1000);
        }

        console.log(' CardGuard ready', { cards: state.cards.length, permission: Notification.permission });
    }

    // ========================================
    // START
    // ========================================

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

</script>

</body>
</html>
